-- 1) Total revenue (JOIN OrderItems â†’ Products)
SELECT SUM(oi.quantity * p.price) AS total_revenue
FROM OrderItems oi
JOIN Products p ON oi.product_id = p.product_id;

-- 2) Revenue and units sold per product (product-level aggregation)
SELECT p.product_id, p.product_name,
       SUM(oi.quantity * p.price) AS revenue,
       SUM(oi.quantity) AS units_sold
FROM OrderItems oi
JOIN Products p ON oi.product_id = p.product_id
GROUP BY p.product_id, p.product_name
ORDER BY revenue DESC;

-- 3) Top selling products (by quantity)
SELECT p.product_name,
       SUM(oi.quantity) AS total_qty
FROM OrderItems oi
JOIN Products p ON oi.product_id = p.product_id
GROUP BY p.product_name
ORDER BY total_qty DESC
LIMIT 5;

-- 4) Order-level details with customer name and total amount per order
SELECT o.order_id, o.order_date, c.customer_name,
       SUM(oi.quantity * p.price) AS order_total
FROM Orders o
JOIN Customers c ON o.customer_id = c.customer_id
JOIN OrderItems oi ON o.order_id = oi.order_id
JOIN Products p ON oi.product_id = p.product_id
GROUP BY o.order_id, o.order_date, c.customer_name
ORDER BY o.order_date;

-- 5) Monthly revenue trend (SQLite: use strftime)
SELECT strftime('%Y-%m', o.order_date) AS month,
       SUM(oi.quantity * p.price) AS revenue
FROM Orders o
JOIN OrderItems oi ON o.order_id = oi.order_id
JOIN Products p ON oi.product_id = p.product_id
GROUP BY month
ORDER BY month;

-- 6) Customer spending (how much each customer spent)
SELECT c.customer_id, c.customer_name,
       COALESCE(SUM(oi.quantity * p.price),0) AS amount_spent,
       COUNT(DISTINCT o.order_id) AS orders_count
FROM Customers c
LEFT JOIN Orders o ON c.customer_id = o.customer_id
LEFT JOIN OrderItems oi ON o.order_id = oi.order_id
LEFT JOIN Products p ON oi.product_id = p.product_id
GROUP BY c.customer_id, c.customer_name
ORDER BY amount_spent DESC;

-- 7) Customers with NO orders (LEFT JOIN + NULL check)
SELECT c.customer_id, c.customer_name
FROM Customers c
LEFT JOIN Orders o ON c.customer_id = o.customer_id
WHERE o.order_id IS NULL;

-- 8) Create the sales_summary view (clean refresh)
DROP VIEW IF EXISTS sales_summary;

CREATE VIEW sales_summary AS
SELECT 
    o.order_id,
    o.order_date,
    c.customer_name,
    c.city,
    p.product_name,
    p.category,
    oi.quantity,
    (oi.quantity * p.price) AS amount
FROM Orders o
JOIN Customers c ON o.customer_id = c.customer_id
JOIN OrderItems oi ON o.order_id = oi.order_id
JOIN Products p ON oi.product_id = p.product_id;

-- Show refreshed view
SELECT * 
FROM sales_summary
ORDER BY order_date, order_id;

-- 9) Show the view (ordered)
SELECT * FROM sales_summary ORDER BY order_date, order_id;

-- 10) Running total of revenue by order_date (window function)
SELECT order_date,
       SUM(daily_amount) AS daily_revenue,
       SUM(SUM(daily_amount)) OVER (ORDER BY order_date ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW) AS running_revenue
FROM (
  SELECT o.order_date, SUM(oi.quantity * p.price) AS daily_amount
  FROM Orders o
  JOIN OrderItems oi ON o.order_id = oi.order_id
  JOIN Products p ON oi.product_id = p.product_id
  GROUP BY o.order_date
) AS daily
GROUP BY order_date
ORDER BY order_date;
